<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/class-style.css}" />
    <link rel="icon" th:href="@{/image/login/PTIT_LOGO.png}" />

    <title>Cập nhật lớp học</title>
  </head>

  <body>
    <nav>
      <div class="nav_function">
        <img th:src="@{/image/homepage/PTIT_LOGO_WHITE.png}" alt="PTIT Logo" />
        <div>
          <a th:href="@{/teacher/classroom}">Lớp học</a>
        </div>
      </div>
      <div class="nav_user_info">
        <div id="nav_username">
          <h4 th:text="${userDTO.lastname} + ' ' + ${userDTO.firstname}">
            Tên người dùng
          </h4>
          <h5
            th:text="${userDTO.role == 'TEACHER' ? 'Giáo viên' :
               (userDTO.role == 'STUDENT' ? 'Sinh viên' :
               (userDTO.role == 'STUDENT' ? 'Quản trị viên' : 'null'
            ))}"
          >
            Vai trò
          </h5>
        </div>
        <div id="user_more_tools">
          ▼
          <ul class="user-menu">
            <li><a th:href="@{/user-info}">Hồ sơ</a></li>
            <li><a href="#">Hướng dẫn</a></li>
            <li>
              <form th:action="@{/logout}" method="post" id="logout_button">
                <button type="submit">Đăng xuất</button>
              </form>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="mt-4">
        <h2 class="text-left title-create">
          Tạo Đề thi Lớp
          <span th:text="${classroom.className}"></span>
        </h2>
        <div class="mt-5">
          <div class="message">
            <div th:if="${success}" id="success-message">
              <p th:text="${success}"></p>
            </div>

            <div th:if="${error}" id="error-message">
              <p th:text="${error}"></p>
            </div>
            <script>
              // Kiểm tra nếu phần tử success-message tồn tại trên trang
              window.addEventListener("load", function () {
                var successMessage = document.getElementById("success-message");
                if (successMessage) {
                  // Ẩn thông báo sau 5 giây
                  setTimeout(function () {
                    successMessage.style.display = "none";
                  }, 5000);
                }

                var errorMessage = document.getElementById("error-message");

                if (errorMessage) {
                  // Ẩn thông báo sau 5 giây
                  setTimeout(function () {
                    errorMessage.style.display = "none";
                  }, 5000);
                }
              });
            </script>
          </div>

          <p th:if="${totalItems == 0}" class="text-center mt-4 text-danger">
            Không có sinh viên nào trong lớp
          </p>

          <div
            class="mt-4 d-flex justify-content-center"
            th:if="${totalItems >= 1}"
            aria-label="Page navigation example"
          >
            <ul class="pagination">
              <!-- Previous Button -->
              <li
                class="page-item"
                th:classappend="${currentPage == 1} ? 'disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/teacher/classroom/update/{id}(id=${classroom.classId}, current=${currentPage - 1}, pageSize=${pageSize})}"
                  aria-label="Previous"
                >
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>

              <!-- Page Numbers -->
              <li
                th:each="i : ${#numbers.sequence(1, totalPages)}"
                class="page-item"
                th:classappend="${i == currentPage} ? 'active'"
              >
                <a
                  class="page-link"
                  th:href="@{/teacher/classroom/update/{id}(id=${classroom.classId}, current=${i}, pageSize=${pageSize})}"
                  th:text="${i}"
                ></a>
              </li>

              <!-- Next Button -->
              <li
                class="page-item"
                th:classappend="${currentPage == totalPages} ? 'disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/teacher/classroom/update/{id}(id=${classroom.classId}, current=${currentPage + 1}, pageSize=${pageSize})}"
                  aria-label="Next"
                >
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class=".d-flex">
          <form
            th:action="@{'/teacher/classroom/' + ${classroom.classId} + '/exam/create'}"
            method="post"
            th:object="${examForm}"
          >
            <div class="form-group">
              <label class="h5" for="examTitle">Tên đề thi:</label>
              <input class="form-control" type="text" th:field="*{examTitle}" />
            </div>
            <div class="form-group">
              <label class="h5" for="examDuration">Thời gian:</label>
              <input
                class="form-control"
                type="text"
                th:field="*{examDuration}"
              />
            </div>
            <div
              id="question_form"
              th:each="question, iterStat : ${examForm.questionList}"
            ></div>
            <input
              onclick="createNewQuestion()"
              class="btn primary mb-3"
              value="Thêm câu hỏi"
            />
            <input
              type="submit"
              class="btn btn-danger mb-3"
              value="Tạo đề thi"
            />
          </form>
        </div>
      </div>
    </div>
  </body>

  <script>
    function createNewQuestion() {
      var form = `<div>
                <label for="questionContent">Câu hỏi ${iterStat.index}:</label>
                <textarea class="form-control" rows="3" type="text" th:field="*{tasks[__${iterStat.index}__].name}" placeholder="Nội dung câu hỏi..." />
            </div>`;
      document.getElementById("question_form").appendChild(form);
    }

    document.addEventListener("DOMContentLoaded", function () {
      const moreTools = document.getElementById("user_more_tools");
      const userMenu = moreTools.querySelector(".user-menu");

      // Toggle menu khi bấm vào biểu tượng tam giác
      moreTools.addEventListener("click", (event) => {
        event.stopPropagation(); // Ngăn không để sự kiện bấm vào phần tử cha
        userMenu.classList.toggle("show");
      });

      // Đóng menu khi bấm ra ngoài
      document.addEventListener("click", (event) => {
        if (!moreTools.contains(event.target)) {
          // Kiểm tra nếu không bấm vào trong menu
          userMenu.classList.remove("show"); // Xóa lớp 'show' để ẩn menu
        }
      });

      // Tìm kiếm sinh viên

      const studentInput = document.getElementById("studentId-inp");
      const dropdown = document.getElementById("student-dropdown");

      let debounceTimeout;

      studentInput.addEventListener("input", function () {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          const query = studentInput.value.trim();
          if (query) {
            fetch(`/ptit-exam/api/student/search?id=${query}`)
              .then((response) => response.json())
              .then((data) => {
                dropdown.innerHTML = "";
                if (data.length) {
                  data.forEach((student) => {
                    const item = document.createElement("a");
                    item.classList.add("dropdown-item", "text-danger");
                    item.href = "#";
                    item.textContent = student.studentId + " - " + student.name;

                    item.addEventListener("click", function () {
                      studentInput.value = student.studentId;
                      dropdown.classList.remove("show");
                    });
                    dropdown.appendChild(item);
                  });
                  dropdown.classList.add("show");
                } else {
                  const noResultItem = document.createElement("div");
                  noResultItem.classList.add("dropdown-item", "text-muted");
                  noResultItem.textContent =
                    "Không tìm thấy sinh viên nào có mã tương ứng";
                  dropdown.appendChild(noResultItem);
                  dropdown.classList.add("show");
                }
              })
              .catch((error) => {
                dropdown.classList.remove("show");
              });
          } else {
            dropdown.classList.remove("show");
          }
        }, 200); // 300ms debounce time
      });

      document.addEventListener("click", function (e) {
        if (!studentInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove("show");
        }
      });

      // Sắp xếp sinh viên

      const sortButton = document.querySelector(".sort-student");
      const sortOrderSelect = document.getElementById("sort_order");
      const sortCriteriaSelect = document.getElementById("sort_criteria");

      sortButton.addEventListener("click", function () {
        const sortOrder = sortOrderSelect.value;
        const sortCriteria = sortCriteriaSelect.value;

        let queryParams = new URLSearchParams(window.location.search);

        if (sortOrder !== "default" && sortCriteria !== "default") {
          queryParams.set("sort", sortOrder);
          queryParams.set("key", sortCriteria);
        } else {
          queryParams.delete("sort");
          queryParams.delete("key");
        }

        window.location.search = queryParams.toString();
      });

      // Tìm kiếm lớp sinh viên

      const searchButton = document.querySelector(".search-student");
      const searchInput = document.getElementById("search_input");

      searchButton.addEventListener("click", function () {
        const searchInput = document.getElementById("search_input");
        const searchValue = searchInput.value;

        let queryParams = new URLSearchParams(window.location.search);

        queryParams.delete("current");
        queryParams.delete("pageSize");
        if (searchValue) {
          queryParams.set("search", searchValue);
        } else {
          queryParams.delete("search");
        }

        window.location.search = queryParams.toString();
      });

      searchInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          searchButton.click();
        }
      });
    });
  </script>
</html>
